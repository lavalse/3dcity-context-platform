<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°æ±åŒº 3Déƒ½å¸‚ãƒ¢ãƒ‡ãƒ« å•ã„åˆã‚ã›ã‚·ã‚¹ãƒ†ãƒ </title>

  <!-- MapLibre GL JS -->
  <link href="https://unpkg.com/maplibre-gl@4/dist/maplibre-gl.css" rel="stylesheet">
  <script src="https://unpkg.com/maplibre-gl@4/dist/maplibre-gl.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Sans", sans-serif;
      background: #f4f6f9;
      color: #1a1a2e;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* â”€â”€ Header â”€â”€ */
    header {
      background: #1a3a5c;
      color: white;
      padding: 12px 32px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-shrink: 0;
    }
    header h1 { font-size: 1.05rem; font-weight: 600; }
    header p  { font-size: 0.78rem; opacity: 0.7; margin-top: 2px; }
    .mode-badge {
      margin-left: auto;
      font-size: 0.72rem;
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 500;
      background: rgba(255,255,255,0.15);
    }
    .mode-badge.llm         { background: #22c55e33; color: #86efac; }
    .mode-badge.placeholder { background: #f59e0b33; color: #fcd34d; }

    /* â”€â”€ Tab bar â”€â”€ */
    .tab-bar {
      background: white;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      gap: 0;
      flex-shrink: 0;
    }
    .tab-btn {
      padding: 10px 28px;
      font-size: 0.88rem;
      font-weight: 600;
      border: none;
      background: none;
      cursor: pointer;
      color: #64748b;
      border-bottom: 3px solid transparent;
      transition: all 0.15s;
      font-family: inherit;
    }
    .tab-btn:hover { color: #1a3a5c; background: #f8fafc; }
    .tab-btn.active { color: #1a3a5c; border-bottom-color: #1a3a5c; }

    /* â”€â”€ Tab panes â”€â”€ */
    .tab-pane { display: none; flex: 1; overflow: hidden; }
    .tab-pane.active { display: flex; flex-direction: column; }

    /* â”€â”€ Query tab â”€â”€ */
    #tab-query { overflow-y: auto; }
    #tab-query > main {
      max-width: 960px;
      margin: 0 auto;
      padding: 28px 24px;
      width: 100%;
    }

    /* â”€â”€ Query card â”€â”€ */
    .query-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    .query-card label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: #475569;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .input-row { display: flex; gap: 10px; }
    .input-row input {
      flex: 1;
      padding: 12px 16px;
      font-size: 1rem;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      outline: none;
      transition: border-color 0.2s;
      font-family: inherit;
    }
    .input-row input:focus { border-color: #1a3a5c; }
    .input-row button {
      padding: 12px 24px;
      background: #1a3a5c;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }
    .input-row button:hover     { background: #2563a8; }
    .input-row button:disabled  { background: #94a3b8; cursor: not-allowed; }

    /* â”€â”€ Example chips â”€â”€ */
    .examples {
      margin-top: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .examples span { font-size: 0.75rem; color: #64748b; align-self: center; }
    .example-chip {
      font-size: 0.78rem;
      padding: 5px 12px;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      border-radius: 20px;
      cursor: pointer;
      color: #334155;
      transition: all 0.15s;
    }
    .example-chip:hover { background: #dbeafe; border-color: #93c5fd; color: #1d4ed8; }

    /* â”€â”€ Results â”€â”€ */
    .results { margin-top: 24px; display: flex; flex-direction: column; gap: 16px; }

    /* â”€â”€ SQL box â”€â”€ */
    .sql-card { background: #0f172a; border-radius: 10px; overflow: hidden; }
    .sql-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      background: #1e293b;
    }
    .sql-card-header span { font-size: 0.75rem; color: #94a3b8; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; }
    .sql-explanation { font-size: 0.78rem; color: #64748b; font-style: italic; }
    .copy-btn {
      background: none;
      border: 1px solid #334155;
      color: #94a3b8;
      padding: 3px 10px;
      border-radius: 4px;
      font-size: 0.72rem;
      cursor: pointer;
    }
    .copy-btn:hover { background: #334155; color: white; }
    pre#sql-display {
      padding: 16px;
      color: #e2e8f0;
      font-family: "Cascadia Code", "Fira Code", "Courier New", monospace;
      font-size: 0.85rem;
      line-height: 1.6;
      overflow-x: auto;
      white-space: pre;
    }

    /* â”€â”€ Results table â”€â”€ */
    .table-card { background: white; border-radius: 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); overflow: hidden; }
    .table-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid #f1f5f9;
      background: #fafafa;
    }
    .table-header span { font-size: 0.82rem; font-weight: 600; color: #475569; }
    .row-count { font-size: 0.75rem; padding: 3px 10px; background: #e0f2fe; color: #0369a1; border-radius: 12px; font-weight: 600; }
    .table-scroll { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    thead tr { background: #f8fafc; }
    th { padding: 10px 14px; text-align: left; font-size: 0.78rem; font-weight: 700; color: #475569; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 2px solid #e2e8f0; }
    td { padding: 9px 14px; font-size: 0.88rem; border-bottom: 1px solid #f1f5f9; color: #1e293b; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #f8fafc; }
    td.numeric { text-align: right; font-variant-numeric: tabular-nums; }

    /* â”€â”€ Error & spinner â”€â”€ */
    .error-card { background: #fef2f2; border: 1px solid #fecaca; border-radius: 10px; padding: 14px 18px; color: #dc2626; font-size: 0.88rem; }
    .spinner { display: flex; align-items: center; gap: 12px; padding: 20px; color: #64748b; font-size: 0.9rem; }
    .spinner::before { content: ""; width: 20px; height: 20px; border: 3px solid #e2e8f0; border-top-color: #1a3a5c; border-radius: 50%; animation: spin 0.7s linear infinite; flex-shrink: 0; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .empty-state { text-align: center; padding: 48px 24px; color: #94a3b8; }
    .empty-state svg { width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.4; }
    .empty-state p { font-size: 0.9rem; }

    /* â”€â”€ Map tab â”€â”€ */
    #tab-map { flex-direction: row; }

    #map-container { flex: 1; position: relative; }
    #map { width: 100%; height: 100%; }

    /* map status overlay */
    #map-status {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(26,58,92,0.85);
      color: white;
      font-size: 0.78rem;
      padding: 5px 14px;
      border-radius: 20px;
      pointer-events: none;
      z-index: 10;
      transition: opacity 0.3s;
    }
    #map-status.hidden { opacity: 0; }

    /* â”€â”€ Detail panel â”€â”€ */
    #detail-panel {
      width: 300px;
      background: white;
      border-left: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      flex-shrink: 0;
    }
    .detail-header {
      padding: 14px 16px;
      background: #1a3a5c;
      color: white;
      font-size: 0.88rem;
      font-weight: 600;
    }
    .detail-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    .detail-empty {
      color: #94a3b8;
      font-size: 0.82rem;
      text-align: center;
      margin-top: 40px;
      line-height: 1.6;
    }

    /* attribute rows */
    .attr-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      padding: 6px 0;
      border-bottom: 1px solid #f1f5f9;
      font-size: 0.82rem;
    }
    .attr-row:last-child { border-bottom: none; }
    .attr-label { color: #64748b; font-weight: 500; }
    .attr-value { color: #1e293b; font-weight: 600; text-align: right; max-width: 160px; word-break: break-all; }

    /* LOD buttons */
    .lod-section { margin-top: 16px; }
    .lod-title { font-size: 0.75rem; font-weight: 700; color: #475569; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; }
    .lod-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
    .lod-btn {
      flex: 1;
      padding: 8px 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      background: white;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      color: #475569;
      transition: all 0.15s;
      text-align: center;
      font-family: inherit;
    }
    .lod-btn:hover   { border-color: #1a3a5c; color: #1a3a5c; }
    .lod-btn.active  { background: #1a3a5c; color: white; border-color: #1a3a5c; }
    .lod-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    /* LOD legend */
    .lod-legend { margin-top: 12px; font-size: 0.75rem; }
    .legend-item { display: flex; align-items: center; gap: 6px; margin-top: 5px; color: #475569; }
    .legend-dot { width: 10px; height: 10px; border-radius: 2px; flex-shrink: 0; }

    .hidden { display: none !important; }
  </style>
</head>
<body>

<header>
  <div>
    <h1>å°æ±åŒº 3Déƒ½å¸‚ãƒ¢ãƒ‡ãƒ« å•ã„åˆã‚ã›ã‚·ã‚¹ãƒ†ãƒ </h1>
    <p>Taito-ku 3D City Model Â· Natural Language Query &amp; Map Viewer</p>
  </div>
  <div id="mode-badge" class="mode-badge">connectingâ€¦</div>
</header>

<!-- Tab bar -->
<nav class="tab-bar">
  <button class="tab-btn active" id="tab-btn-query" onclick="switchTab('query')">ã‚¯ã‚¨ãƒª / Query</button>
  <button class="tab-btn"        id="tab-btn-map"   onclick="switchTab('map')">åœ°å›³ / Map</button>
</nav>

<!-- â•â• Tab 1: Query â•â• -->
<div class="tab-pane active" id="tab-query">
  <main>
    <div class="query-card">
      <label for="question-input">è³ªå• / Question</label>
      <div class="input-row">
        <input
          id="question-input"
          type="text"
          placeholder="ä¾‹: å°æ±åŒºã®ä½å®…ã¯ä½•æ£Ÿã‚ã‚Šã¾ã™ã‹ï¼Ÿ / How many residential buildings?"
          autocomplete="off"
        />
        <button id="submit-btn" onclick="submitQuery()">æ¤œç´¢ / Search</button>
      </div>
      <div class="examples">
        <span>ä¾‹ï¼š</span>
        <div class="example-chip" onclick="ask(this)">How many residential buildings?</div>
        <div class="example-chip" onclick="ask(this)">Building count by usage type</div>
        <div class="example-chip" onclick="ask(this)">Top 10 tallest buildings</div>
        <div class="example-chip" onclick="ask(this)">Height distribution</div>
        <div class="example-chip" onclick="ask(this)">Buildings near flood zone</div>
        <div class="example-chip" onclick="ask(this)">How many public facilities?</div>
      </div>
    </div>

    <div class="results" id="results">
      <div class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 15.803a7.5 7.5 0 0010.607 0z"/>
        </svg>
        <p>è³ªå•ã‚’å…¥åŠ›ã—ã¦æ¤œç´¢ã—ã¦ãã ã•ã„</p>
      </div>
    </div>
  </main>
</div>

<!-- â•â• Tab 2: Map â•â• -->
<div class="tab-pane" id="tab-map">
  <div id="map-container">
    <div id="map"></div>
    <div id="map-status" class="hidden">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
  </div>

  <div id="detail-panel">
    <div class="detail-header">å»ºç‰©è©³ç´° / Building Detail</div>
    <div class="detail-body" id="detail-body">
      <div class="detail-empty">
        åœ°å›³ä¸Šã®å»ºç‰©ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨<br>è©³ç´°æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
      </div>
    </div>
  </div>
</div>

<script>
const API = '/api';

// â”€â”€ Usage color map â”€â”€
const USAGE_COLORS = {
  '411': '#4CAF50',
  '412': '#8BC34A',
  '413': '#CDDC39',
  '414': '#AFB42B',
  '415': '#9E9D24',
  '401': '#2196F3',
  '402': '#03A9F4',
  '403': '#00BCD4',
  '404': '#0097A7',
  '421': '#9C27B0',
  '422': '#E91E63',
  '431': '#FF5722',
  '441': '#795548',
  '454': '#607D8B',
  '461': '#9E9E9E',
};
const DEFAULT_COLOR = '#FF9800';

// â”€â”€ Tab switching â”€â”€
let mapInitialized = false;

function switchTab(name) {
  document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
  document.getElementById(`tab-${name}`).classList.add('active');
  document.getElementById(`tab-btn-${name}`).classList.add('active');

  if (name === 'map' && !mapInitialized) {
    initMap();
    mapInitialized = true;
  }
}

// â”€â”€ Health check â”€â”€
async function checkHealth() {
  try {
    const res  = await fetch(`${API}/health`);
    const data = await res.json();
    const badge = document.getElementById('mode-badge');
    if (data.db === 'connected') {
      if (data.llm_mode === 'claude_api') {
        badge.textContent = 'ğŸŸ¢ Claude API';
        badge.className = 'mode-badge llm';
      } else {
        badge.textContent = 'ğŸŸ¡ Placeholder mode';
        badge.className = 'mode-badge placeholder';
      }
    } else {
      badge.textContent = 'ğŸ”´ DB offline';
    }
  } catch {
    document.getElementById('mode-badge').textContent = 'ğŸ”´ API offline';
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ Query tab logic â”€â”€
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function ask(el) {
  document.getElementById('question-input').value = el.textContent;
  submitQuery();
}

document.getElementById('question-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') submitQuery();
});

async function submitQuery() {
  const question = document.getElementById('question-input').value.trim();
  if (!question) return;

  const btn = document.getElementById('submit-btn');
  btn.disabled = true;
  btn.textContent = 'æ¤œç´¢ä¸­â€¦';

  const resultsEl = document.getElementById('results');
  resultsEl.innerHTML = '<div class="spinner">Generating SQL and querying databaseâ€¦</div>';

  try {
    const res = await fetch(`${API}/query`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ question, execute: true }),
    });
    const data = await res.json();
    renderResults(data);
  } catch (err) {
    resultsEl.innerHTML = `<div class="error-card">Network error: ${err.message}</div>`;
  } finally {
    btn.disabled = false;
    btn.textContent = 'æ¤œç´¢ / Search';
  }
}

function renderResults(data) {
  const resultsEl = document.getElementById('results');
  resultsEl.innerHTML = '';

  const sqlCard = document.createElement('div');
  sqlCard.className = 'sql-card';
  sqlCard.innerHTML = `
    <div class="sql-card-header">
      <span>Generated SQL</span>
      <span class="sql-explanation">${escHtml(data.explanation)}</span>
      <button class="copy-btn" onclick="copySQL()">Copy</button>
    </div>
    <pre id="sql-display">${escHtml(data.sql)}</pre>
  `;
  resultsEl.appendChild(sqlCard);

  if (data.error) {
    const errCard = document.createElement('div');
    errCard.className = 'error-card';
    errCard.textContent = `Query error: ${data.error}`;
    resultsEl.appendChild(errCard);
    return;
  }

  if (!data.executed) return;

  const tableCard = document.createElement('div');
  tableCard.className = 'table-card';

  const header = document.createElement('div');
  header.className = 'table-header';
  header.innerHTML = `
    <span>Results</span>
    <span class="row-count">${data.row_count.toLocaleString()} row${data.row_count !== 1 ? 's' : ''}</span>
  `;
  tableCard.appendChild(header);

  if (data.row_count === 0) {
    tableCard.innerHTML += '<div style="padding:24px;text-align:center;color:#94a3b8;font-size:0.88rem;">No results found.</div>';
  } else {
    const scroll = document.createElement('div');
    scroll.className = 'table-scroll';
    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const hrow  = document.createElement('tr');
    data.columns.forEach(col => {
      const th = document.createElement('th');
      th.textContent = col;
      hrow.appendChild(th);
    });
    thead.appendChild(hrow);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    data.rows.forEach(row => {
      const tr = document.createElement('tr');
      row.forEach(cell => {
        const td = document.createElement('td');
        td.textContent = cell === null ? 'â€”' : cell;
        if (typeof cell === 'number') td.className = 'numeric';
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    scroll.appendChild(table);
    tableCard.appendChild(scroll);
  }

  resultsEl.appendChild(tableCard);
}

function escHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;').replace(/</g, '&lt;')
    .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function copySQL() {
  const sql = document.getElementById('sql-display')?.textContent;
  if (sql) navigator.clipboard.writeText(sql).then(() => {
    const btn = document.querySelector('.copy-btn');
    btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = 'Copy', 1500);
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ Map tab logic â”€â”€
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let map = null;
let selectedGmlid = null;
let lod1Active = false;
let lod2Active = false;
let loadTimer = null;

function initMap() {
  map = new maplibregl.Map({
    container: 'map',
    style: 'https://tiles.openfreemap.org/styles/liberty',
    center: [139.7833, 35.7122],
    zoom: 14,
    pitch: 45,
    bearing: -15,
    antialias: true,
  });

  map.addControl(new maplibregl.NavigationControl(), 'top-right');

  map.on('load', () => {
    // Add empty GeoJSON sources
    map.addSource('buildings', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
    map.addSource('selected-lod1', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
    map.addSource('selected-lod2-wall',   { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
    map.addSource('selected-lod2-roof',   { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
    map.addSource('selected-lod2-ground', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });

    // Buildings fill-extrusion (LOD0 overview with height)
    map.addLayer({
      id: 'buildings-extrusion',
      type: 'fill-extrusion',
      source: 'buildings',
      paint: {
        'fill-extrusion-color': [
          'match', ['get', 'usage'],
          '411', '#4CAF50', '412', '#8BC34A', '413', '#CDDC39',
          '414', '#AFB42B', '415', '#9E9D24',
          '401', '#2196F3', '402', '#03A9F4', '403', '#00BCD4', '404', '#0097A7',
          '421', '#9C27B0', '422', '#E91E63',
          '431', '#FF5722', '441', '#795548',
          '454', '#607D8B', '461', '#9E9E9E',
          '#FF9800'
        ],
        'fill-extrusion-height': ['get', 'measured_height'],
        'fill-extrusion-base': 0,
        'fill-extrusion-opacity': 0.85,
      },
    });

    // Selected building highlight (white outline over the extrusion)
    map.addLayer({
      id: 'buildings-selected',
      type: 'fill-extrusion',
      source: 'buildings',
      filter: ['==', 'gmlid', ''],
      paint: {
        'fill-extrusion-color': '#ffffff',
        'fill-extrusion-height': ['get', 'measured_height'],
        'fill-extrusion-base': 0,
        'fill-extrusion-opacity': 0.5,
      },
    });

    // LOD1 outline (yellow polygon)
    map.addLayer({
      id: 'selected-lod1-fill',
      type: 'fill',
      source: 'selected-lod1',
      paint: { 'fill-color': '#FFD600', 'fill-opacity': 0.3 },
    });
    map.addLayer({
      id: 'selected-lod1-line',
      type: 'line',
      source: 'selected-lod1',
      paint: { 'line-color': '#FFD600', 'line-width': 2 },
    });

    // LOD2 surface layers
    map.addLayer({
      id: 'selected-lod2-ground-fill',
      type: 'fill',
      source: 'selected-lod2-ground',
      paint: { 'fill-color': '#4CAF50', 'fill-opacity': 0.5 },
    });
    map.addLayer({
      id: 'selected-lod2-roof-fill',
      type: 'fill',
      source: 'selected-lod2-roof',
      paint: { 'fill-color': '#2196F3', 'fill-opacity': 0.6 },
    });
    map.addLayer({
      id: 'selected-lod2-wall-fill',
      type: 'fill',
      source: 'selected-lod2-wall',
      paint: { 'fill-color': '#FF9800', 'fill-opacity': 0.5 },
    });
    map.addLayer({
      id: 'selected-lod2-wall-line',
      type: 'line',
      source: 'selected-lod2-wall',
      paint: { 'line-color': '#FF6D00', 'line-width': 1.5 },
    });

    // Click on building
    map.on('click', 'buildings-extrusion', e => {
      const props = e.features[0].properties;
      selectBuilding(props.gmlid);
    });

    map.on('mouseenter', 'buildings-extrusion', () => {
      map.getCanvas().style.cursor = 'pointer';
    });
    map.on('mouseleave', 'buildings-extrusion', () => {
      map.getCanvas().style.cursor = '';
    });

    // Load buildings whenever map stops moving
    map.on('moveend', () => {
      clearTimeout(loadTimer);
      loadTimer = setTimeout(loadBuildingsInView, 300);
    });

    loadBuildingsInView();
  });
}

// â”€â”€ Load buildings for current viewport â”€â”€
async function loadBuildingsInView() {
  if (!map) return;
  const bounds = map.getBounds();
  const bbox = [
    bounds.getWest().toFixed(6),
    bounds.getSouth().toFixed(6),
    bounds.getEast().toFixed(6),
    bounds.getNorth().toFixed(6),
  ].join(',');

  showMapStatus('å»ºç‰©ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­â€¦');
  try {
    const res  = await fetch(`${API}/buildings?bbox=${bbox}`);
    const data = await res.json();
    map.getSource('buildings').setData(data);

    const msg = data.truncated
      ? `${data.count.toLocaleString()} æ£Ÿè¡¨ç¤ºä¸­ï¼ˆåˆ¶é™è¶…é â€” ã‚ºãƒ¼ãƒ ã‚¤ãƒ³ã—ã¦ãã ã•ã„ï¼‰`
      : `${data.count.toLocaleString()} æ£Ÿ`;
    showMapStatus(msg, 2000);
  } catch (err) {
    showMapStatus('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + err.message, 3000);
  }
}

function showMapStatus(msg, hideAfterMs = null) {
  const el = document.getElementById('map-status');
  el.textContent = msg;
  el.classList.remove('hidden');
  if (hideAfterMs) {
    setTimeout(() => el.classList.add('hidden'), hideAfterMs);
  }
}

// â”€â”€ Select a building â”€â”€
async function selectBuilding(gmlid) {
  selectedGmlid = gmlid;
  lod1Active = false;
  lod2Active = false;

  // Highlight in the overview layer
  map.setFilter('buildings-selected', ['==', 'gmlid', gmlid]);

  // Clear previous LOD layers
  clearLodLayers();

  // Show loading in panel
  document.getElementById('detail-body').innerHTML = '<div class="spinner">Loadingâ€¦</div>';

  try {
    const res  = await fetch(`${API}/buildings/${gmlid}`);
    const data = await res.json();
    renderDetailPanel(data);
  } catch (err) {
    document.getElementById('detail-body').innerHTML =
      `<div class="error-card" style="margin:16px">ã‚¨ãƒ©ãƒ¼: ${err.message}</div>`;
  }
}

// â”€â”€ Render attribute panel â”€â”€
function renderDetailPanel(data) {
  const a = data.attributes;
  const hasLod2 = a.has_lod2;

  const rows = [
    ['GML ID',   data.gmlid],
    ['ç”¨é€”',      `${a.usage_label} (${a.usage || 'â€”'})`],
    ['é«˜ã•',      a.measured_height != null ? `${a.measured_height} m` : 'ä¸æ˜'],
    ['åœ°ä¸Šéšæ•°',  a.storeys_above_ground != null ? `${a.storeys_above_ground} éš` : 'ä¸æ˜'],
    ['åœ°ä¸‹éšæ•°',  a.storeys_below_ground ? `${a.storeys_below_ground} éš` : 'â€”'],
  ];

  const attrsHtml = rows.map(([label, value]) => `
    <div class="attr-row">
      <span class="attr-label">${label}</span>
      <span class="attr-value">${escHtml(String(value))}</span>
    </div>
  `).join('');

  const lod2Disabled = !hasLod2 ? 'disabled title="ã“ã®ãƒ“ãƒ«ã¯LOD2ãƒ‡ãƒ¼ã‚¿ãªã—"' : '';

  document.getElementById('detail-body').innerHTML = `
    <div>${attrsHtml}</div>

    <div class="lod-section">
      <div class="lod-title">ã‚¸ã‚ªãƒ¡ãƒˆãƒªè¡¨ç¤º</div>
      <div class="lod-buttons">
        <button class="lod-btn" id="lod1-btn" onclick="toggleLod1()">LOD1</button>
        <button class="lod-btn" id="lod2-btn" onclick="toggleLod2()" ${lod2Disabled}>LOD2</button>
      </div>
      <div class="lod-legend" id="lod-legend" style="display:none">
        <div class="legend-item"><div class="legend-dot" style="background:#4CAF50"></div>åœ°é¢ Ground</div>
        <div class="legend-item"><div class="legend-dot" style="background:#2196F3"></div>å±‹æ ¹ Roof</div>
        <div class="legend-item"><div class="legend-dot" style="background:#FF9800"></div>å£ Wall</div>
      </div>
    </div>

    <div style="margin-top:16px; font-size:0.72rem; color:#94a3b8; line-height:1.5">
      ${hasLod2 ? 'LOD2: å£ãƒ»å±‹æ ¹ãƒ»åœ°é¢ã®é¢ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š' : 'LOD2ãƒ‡ãƒ¼ã‚¿ãªã—ï¼ˆLOD1ã®ã¿ï¼‰'}
    </div>
  `;

  // Store data for LOD toggle
  window._currentBuilding = data;
}

// â”€â”€ LOD toggles â”€â”€
function toggleLod1() {
  if (!window._currentBuilding) return;
  lod1Active = !lod1Active;

  const btn = document.getElementById('lod1-btn');
  btn.classList.toggle('active', lod1Active);

  if (lod1Active) {
    map.getSource('selected-lod1').setData(window._currentBuilding.lod1);
  } else {
    map.getSource('selected-lod1').setData({ type: 'FeatureCollection', features: [] });
  }
}

function toggleLod2() {
  if (!window._currentBuilding || !window._currentBuilding.attributes.has_lod2) return;
  lod2Active = !lod2Active;

  const btn = document.getElementById('lod2-btn');
  btn.classList.toggle('active', lod2Active);
  document.getElementById('lod-legend').style.display = lod2Active ? 'block' : 'none';

  const lod2 = window._currentBuilding.lod2;
  if (lod2Active) {
    map.getSource('selected-lod2-wall').setData(lod2.wall);
    map.getSource('selected-lod2-roof').setData(lod2.roof);
    map.getSource('selected-lod2-ground').setData(lod2.ground);
  } else {
    clearLodLayers(/* keepLod1 */ true);
  }
}

function clearLodLayers(keepLod1 = false) {
  const empty = { type: 'FeatureCollection', features: [] };
  if (!keepLod1) {
    map.getSource('selected-lod1')?.setData(empty);
  }
  map.getSource('selected-lod2-wall')?.setData(empty);
  map.getSource('selected-lod2-roof')?.setData(empty);
  map.getSource('selected-lod2-ground')?.setData(empty);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
checkHealth();
</script>
</body>
</html>
