<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°æ±åŒº 3Déƒ½å¸‚ãƒ¢ãƒ‡ãƒ« å•ã„åˆã‚ã›ã‚·ã‚¹ãƒ†ãƒ </title>

  <!-- MapLibre GL JS -->
  <link href="https://unpkg.com/maplibre-gl@4/dist/maplibre-gl.css" rel="stylesheet">
  <script src="https://unpkg.com/maplibre-gl@4/dist/maplibre-gl.js"></script>

  <!-- deck.gl â€” LOD2 true 3D surface rendering -->
  <script src="https://unpkg.com/deck.gl@9.0.4/dist.min.js"></script>

  <!-- Turf.js â€” polygon point-in-polygon test for polygon selection mode -->
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Sans", sans-serif;
      background: #f4f6f9;
      color: #1a1a2e;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* â”€â”€ Header â”€â”€ */
    header {
      background: #1a3a5c;
      color: white;
      padding: 12px 32px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-shrink: 0;
    }
    header h1 { font-size: 1.05rem; font-weight: 600; }
    header p  { font-size: 0.78rem; opacity: 0.7; margin-top: 2px; }
    .mode-badge {
      margin-left: auto;
      font-size: 0.72rem;
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 500;
      background: rgba(255,255,255,0.15);
    }
    .mode-badge.llm         { background: #22c55e33; color: #86efac; }
    .mode-badge.placeholder { background: #f59e0b33; color: #fcd34d; }

    /* â”€â”€ Tab bar â”€â”€ */
    .tab-bar {
      background: white;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      gap: 0;
      flex-shrink: 0;
    }
    .tab-btn {
      padding: 10px 28px;
      font-size: 0.88rem;
      font-weight: 600;
      border: none;
      background: none;
      cursor: pointer;
      color: #64748b;
      border-bottom: 3px solid transparent;
      transition: all 0.15s;
      font-family: inherit;
    }
    .tab-btn:hover { color: #1a3a5c; background: #f8fafc; }
    .tab-btn.active { color: #1a3a5c; border-bottom-color: #1a3a5c; }

    /* â”€â”€ Tab panes â”€â”€ */
    .tab-pane { display: none; flex: 1; overflow: hidden; }
    .tab-pane.active { display: flex; flex-direction: column; }

    /* â”€â”€ Query tab â”€â”€ */
    #tab-query { overflow-y: auto; }
    #tab-query > main {
      max-width: 960px;
      margin: 0 auto;
      padding: 28px 24px;
      width: 100%;
    }

    /* â”€â”€ Query card â”€â”€ */
    .query-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    .query-card label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: #475569;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .input-row { display: flex; gap: 10px; }
    .input-row input {
      flex: 1;
      padding: 12px 16px;
      font-size: 1rem;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      outline: none;
      transition: border-color 0.2s;
      font-family: inherit;
    }
    .input-row input:focus { border-color: #1a3a5c; }
    .input-row button {
      padding: 12px 24px;
      background: #1a3a5c;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }
    .input-row button:hover     { background: #2563a8; }
    .input-row button:disabled  { background: #94a3b8; cursor: not-allowed; }

    /* â”€â”€ Example chips â”€â”€ */
    .examples {
      margin-top: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .examples span { font-size: 0.75rem; color: #64748b; align-self: center; }
    .example-chip {
      font-size: 0.78rem;
      padding: 5px 12px;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      border-radius: 20px;
      cursor: pointer;
      color: #334155;
      transition: all 0.15s;
    }
    .example-chip:hover { background: #dbeafe; border-color: #93c5fd; color: #1d4ed8; }

    /* â”€â”€ Results â”€â”€ */
    .results { margin-top: 24px; display: flex; flex-direction: column; gap: 16px; }

    /* â”€â”€ SQL box â”€â”€ */
    .sql-card { background: #0f172a; border-radius: 10px; overflow: hidden; }
    .sql-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      background: #1e293b;
    }
    .sql-card-header span { font-size: 0.75rem; color: #94a3b8; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; }
    .sql-explanation { font-size: 0.78rem; color: #64748b; font-style: italic; }
    .copy-btn {
      background: none;
      border: 1px solid #334155;
      color: #94a3b8;
      padding: 3px 10px;
      border-radius: 4px;
      font-size: 0.72rem;
      cursor: pointer;
    }
    .copy-btn:hover { background: #334155; color: white; }
    pre#sql-display {
      padding: 16px;
      color: #e2e8f0;
      font-family: "Cascadia Code", "Fira Code", "Courier New", monospace;
      font-size: 0.85rem;
      line-height: 1.6;
      overflow-x: auto;
      white-space: pre;
    }

    /* â”€â”€ Results table â”€â”€ */
    .table-card { background: white; border-radius: 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); overflow: hidden; }
    .table-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid #f1f5f9;
      background: #fafafa;
    }
    .table-header span { font-size: 0.82rem; font-weight: 600; color: #475569; }
    .row-count { font-size: 0.75rem; padding: 3px 10px; background: #e0f2fe; color: #0369a1; border-radius: 12px; font-weight: 600; }
    .table-scroll { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    thead tr { background: #f8fafc; }
    th { padding: 10px 14px; text-align: left; font-size: 0.78rem; font-weight: 700; color: #475569; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 2px solid #e2e8f0; }
    td { padding: 9px 14px; font-size: 0.88rem; border-bottom: 1px solid #f1f5f9; color: #1e293b; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #f8fafc; }
    td.numeric { text-align: right; font-variant-numeric: tabular-nums; }

    /* â”€â”€ Error & spinner â”€â”€ */
    .error-card { background: #fef2f2; border: 1px solid #fecaca; border-radius: 10px; padding: 14px 18px; color: #dc2626; font-size: 0.88rem; }
    .spinner { display: flex; align-items: center; gap: 12px; padding: 20px; color: #64748b; font-size: 0.9rem; }
    .spinner::before { content: ""; width: 20px; height: 20px; border: 3px solid #e2e8f0; border-top-color: #1a3a5c; border-radius: 50%; animation: spin 0.7s linear infinite; flex-shrink: 0; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .empty-state { text-align: center; padding: 48px 24px; color: #94a3b8; }
    .empty-state svg { width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.4; }
    .empty-state p { font-size: 0.9rem; }

    /* â”€â”€ Map tab â”€â”€ */
    #tab-map { flex-direction: row; }

    #map-container { flex: 1; position: relative; }
    #map { width: 100%; height: 100%; }

    /* â”€â”€ Detail panel â”€â”€ */
    #detail-panel {
      width: 300px;
      background: white;
      border-left: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      flex-shrink: 0;
    }
    .detail-header {
      padding: 14px 16px;
      background: #1a3a5c;
      color: white;
      font-size: 0.88rem;
      font-weight: 600;
    }
    .detail-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    .detail-empty {
      color: #94a3b8;
      font-size: 0.82rem;
      text-align: center;
      margin-top: 40px;
      line-height: 1.6;
    }

    /* attribute rows */
    .attr-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      padding: 6px 0;
      border-bottom: 1px solid #f1f5f9;
      font-size: 0.82rem;
    }
    .attr-row:last-child { border-bottom: none; }
    .attr-label { color: #64748b; font-weight: 500; }
    .attr-value { color: #1e293b; font-weight: 600; text-align: right; max-width: 160px; word-break: break-all; }

    /* Section title */
    .section-title {
      font-size: 0.7rem;
      font-weight: 700;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin: 14px 0 6px;
    }

    /* LOD buttons */
    .lod-section { margin-top: 4px; }
    .lod-title { font-size: 0.75rem; font-weight: 700; color: #475569; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; }
    .lod-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
    .lod-btn {
      flex: 1;
      padding: 8px 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      background: white;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      color: #475569;
      transition: all 0.15s;
      text-align: center;
      font-family: inherit;
    }
    .lod-btn:hover   { border-color: #1a3a5c; color: #1a3a5c; }
    .lod-btn.active  { background: #1a3a5c; color: white; border-color: #1a3a5c; }
    .lod-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    /* LOD legend */
    .lod-legend { margin-top: 12px; font-size: 0.75rem; }
    .legend-item { display: flex; align-items: center; gap: 6px; margin-top: 5px; color: #475569; }
    .legend-dot { width: 10px; height: 10px; border-radius: 2px; flex-shrink: 0; }

    /* Selection toolbar */
    #selection-toolbar {
      position: absolute; top: 10px; left: 10px; z-index: 10;
      display: flex; gap: 6px; background: white;
      border-radius: 8px; padding: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .sel-btn {
      padding: 6px 12px; border: 2px solid #e2e8f0; border-radius: 6px;
      background: white; font-size: 0.78rem; font-weight: 600;
      cursor: pointer; color: #475569; font-family: inherit;
    }
    .sel-btn:hover  { border-color: #1a3a5c; color: #1a3a5c; }
    .sel-btn.active { background: #1a3a5c; color: white; border-color: #1a3a5c; }

    /* Rubber-band rectangle */
    #rubber-band {
      position: absolute; border: 2px solid #1a3a5c;
      background: rgba(26,58,92,0.1);
      pointer-events: none; display: none; z-index: 5;
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>

<header>
  <div>
    <h1>å°æ±åŒº 3Déƒ½å¸‚ãƒ¢ãƒ‡ãƒ« å•ã„åˆã‚ã›ã‚·ã‚¹ãƒ†ãƒ </h1>
    <p>Taito-ku 3D City Model Â· Natural Language Query &amp; Map Viewer</p>
  </div>
  <div id="mode-badge" class="mode-badge">connectingâ€¦</div>
</header>

<!-- Tab bar -->
<nav class="tab-bar">
  <button class="tab-btn active" id="tab-btn-query" onclick="switchTab('query')">ã‚¯ã‚¨ãƒª / Query</button>
  <button class="tab-btn"        id="tab-btn-map"   onclick="switchTab('map')">åœ°å›³ / Map</button>
</nav>

<!-- â•â• Tab 1: Query â•â• -->
<div class="tab-pane active" id="tab-query">
  <main>
    <div class="query-card">
      <label for="question-input">è³ªå• / Question</label>
      <div class="input-row">
        <input
          id="question-input"
          type="text"
          placeholder="ä¾‹: å°æ±åŒºã®ä½å®…ã¯ä½•æ£Ÿã‚ã‚Šã¾ã™ã‹ï¼Ÿ / How many residential buildings?"
          autocomplete="off"
        />
        <button id="submit-btn" onclick="submitQuery()">æ¤œç´¢ / Search</button>
      </div>
      <div class="examples">
        <span>ä¾‹ï¼š</span>
        <div class="example-chip" onclick="ask(this)">How many residential buildings?</div>
        <div class="example-chip" onclick="ask(this)">Building count by usage type</div>
        <div class="example-chip" onclick="ask(this)">Top 10 tallest buildings</div>
        <div class="example-chip" onclick="ask(this)">Height distribution</div>
        <div class="example-chip" onclick="ask(this)">Buildings near flood zone</div>
        <div class="example-chip" onclick="ask(this)">How many public facilities?</div>
      </div>
    </div>

    <div class="results" id="results">
      <div class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 15.803a7.5 7.5 0 0010.607 0z"/>
        </svg>
        <p>è³ªå•ã‚’å…¥åŠ›ã—ã¦æ¤œç´¢ã—ã¦ãã ã•ã„</p>
      </div>
    </div>
  </main>
</div>

<!-- â•â• Tab 2: Map â•â• -->
<div class="tab-pane" id="tab-map">
  <div id="map-container">
    <div id="map"></div>
    <div id="selection-toolbar">
      <button class="sel-btn active" id="sel-normal-btn" onclick="setSelectionMode('normal')">ã‚¯ãƒªãƒƒã‚¯</button>
      <button class="sel-btn"        id="sel-box-btn"    onclick="setSelectionMode('box')">ãƒœãƒƒã‚¯ã‚¹</button>
      <button class="sel-btn"        id="sel-poly-btn"   onclick="setSelectionMode('polygon')">ãƒãƒªã‚´ãƒ³</button>
      <button class="sel-btn" onclick="clearSelection()" style="color:#dc2626">ã‚¯ãƒªã‚¢</button>
    </div>
    <div id="rubber-band"></div>
  </div>

  <div id="detail-panel">
    <div class="detail-header" id="detail-header">å»ºç‰©è©³ç´° / Building Detail</div>
    <div class="detail-body" id="detail-body">
      <div class="detail-empty">
        åœ°å›³ä¸Šã®å»ºç‰©ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨<br>è©³ç´°æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
      </div>
    </div>
  </div>
</div>

<script>
const API = '/api';

// â”€â”€ Usage color map â”€â”€
const USAGE_COLORS = {
  '411': '#4CAF50',
  '412': '#8BC34A',
  '413': '#CDDC39',
  '414': '#AFB42B',
  '415': '#9E9D24',
  '401': '#2196F3',
  '402': '#03A9F4',
  '403': '#00BCD4',
  '404': '#0097A7',
  '421': '#9C27B0',
  '422': '#E91E63',
  '431': '#FF5722',
  '441': '#795548',
  '454': '#607D8B',
  '461': '#9E9E9E',
};
const DEFAULT_COLOR = '#FF9800';

// â”€â”€ Tab switching â”€â”€
let mapInitialized = false;

function switchTab(name) {
  document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
  document.getElementById(`tab-${name}`).classList.add('active');
  document.getElementById(`tab-btn-${name}`).classList.add('active');

  if (name === 'map' && !mapInitialized) {
    initMap();
    mapInitialized = true;
  }
}

// â”€â”€ Health check â”€â”€
async function checkHealth() {
  try {
    const res  = await fetch(`${API}/health`);
    const data = await res.json();
    const badge = document.getElementById('mode-badge');
    if (data.db === 'connected') {
      if (data.llm_mode === 'claude_api') {
        badge.textContent = 'ğŸŸ¢ Claude API';
        badge.className = 'mode-badge llm';
      } else {
        badge.textContent = 'ğŸŸ¡ Placeholder mode';
        badge.className = 'mode-badge placeholder';
      }
    } else {
      badge.textContent = 'ğŸ”´ DB offline';
    }
  } catch {
    document.getElementById('mode-badge').textContent = 'ğŸ”´ API offline';
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ Query tab logic â”€â”€
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function ask(el) {
  document.getElementById('question-input').value = el.textContent;
  submitQuery();
}

document.getElementById('question-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') submitQuery();
});

async function submitQuery() {
  const question = document.getElementById('question-input').value.trim();
  if (!question) return;

  const btn = document.getElementById('submit-btn');
  btn.disabled = true;
  btn.textContent = 'æ¤œç´¢ä¸­â€¦';

  const resultsEl = document.getElementById('results');
  resultsEl.innerHTML = '<div class="spinner">Generating SQL and querying databaseâ€¦</div>';

  try {
    const res = await fetch(`${API}/query`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ question, execute: true }),
    });
    const data = await res.json();
    renderResults(data);
  } catch (err) {
    resultsEl.innerHTML = `<div class="error-card">Network error: ${err.message}</div>`;
  } finally {
    btn.disabled = false;
    btn.textContent = 'æ¤œç´¢ / Search';
  }
}

function renderResults(data) {
  const resultsEl = document.getElementById('results');
  resultsEl.innerHTML = '';

  const sqlCard = document.createElement('div');
  sqlCard.className = 'sql-card';
  sqlCard.innerHTML = `
    <div class="sql-card-header">
      <span>Generated SQL</span>
      <span class="sql-explanation">${escHtml(data.explanation)}</span>
      <button class="copy-btn" onclick="copySQL()">Copy</button>
    </div>
    <pre id="sql-display">${escHtml(data.sql)}</pre>
  `;
  resultsEl.appendChild(sqlCard);

  if (data.error) {
    const errCard = document.createElement('div');
    errCard.className = 'error-card';
    errCard.textContent = `Query error: ${data.error}`;
    resultsEl.appendChild(errCard);
    return;
  }

  if (!data.executed) return;

  const tableCard = document.createElement('div');
  tableCard.className = 'table-card';

  const header = document.createElement('div');
  header.className = 'table-header';
  header.innerHTML = `
    <span>Results</span>
    <span class="row-count">${data.row_count.toLocaleString()} row${data.row_count !== 1 ? 's' : ''}</span>
  `;
  tableCard.appendChild(header);

  if (data.row_count === 0) {
    tableCard.innerHTML += '<div style="padding:24px;text-align:center;color:#94a3b8;font-size:0.88rem;">No results found.</div>';
  } else {
    const scroll = document.createElement('div');
    scroll.className = 'table-scroll';
    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const hrow  = document.createElement('tr');
    data.columns.forEach(col => {
      const th = document.createElement('th');
      th.textContent = col;
      hrow.appendChild(th);
    });
    thead.appendChild(hrow);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    data.rows.forEach(row => {
      const tr = document.createElement('tr');
      row.forEach(cell => {
        const td = document.createElement('td');
        td.textContent = cell === null ? 'â€”' : cell;
        if (typeof cell === 'number') td.className = 'numeric';
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    scroll.appendChild(table);
    tableCard.appendChild(scroll);
  }

  resultsEl.appendChild(tableCard);
}

function escHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;').replace(/</g, '&lt;')
    .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function copySQL() {
  const sql = document.getElementById('sql-display')?.textContent;
  if (sql) navigator.clipboard.writeText(sql).then(() => {
    const btn = document.querySelector('.copy-btn');
    btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = 'Copy', 1500);
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ Map tab logic â”€â”€
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let map = null;
let deckOverlay = null;

// â”€â”€ Selection state â”€â”€
const selection = {
  mode: 'normal',       // 'normal' | 'box' | 'polygon'
  gmlids: new Set(),
  data: new Map(),      // gmlid â†’ API response (currently selected)
  lod1Active: false,
  lod2Active: false,
};

const buildingCache = new Map();  // persistent fetch cache, max 200 entries

const drawState = { vertices: [] };          // polygon draw
const boxState  = { active: false, startPixel: null, div: null };  // box draw

function initMap() {
  map = new maplibregl.Map({
    container: 'map',
    style: 'https://tiles.openfreemap.org/styles/liberty',
    center: [139.7833, 35.7122],
    zoom: 14,
  });

  map.addControl(new maplibregl.NavigationControl(), 'top-right');

  map.on('load', () => {
    // Remove 3D building extrusions from the basemap style
    map.getStyle().layers
      .filter(l => l.type === 'fill-extrusion')
      .forEach(l => map.removeLayer(l.id));

    // Building footprints via Martin MVT â€” all 72,486 buildings, real LOD1 outlines
    map.addSource('buildings', {
      type: 'vector',
      tiles: [window.location.origin + '/tiles/building_footprints/{z}/{x}/{y}'],
      minzoom: 10,
      maxzoom: 16,
    });
    map.addSource('selected-lod1', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
    map.addSource('selected-lod2-wall',   { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
    map.addSource('selected-lod2-roof',   { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
    map.addSource('selected-lod2-ground', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
    map.addSource('draw-polygon',  { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
    map.addSource('draw-vertices', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });

    // Buildings flat fill (LOD1 footprints colored by usage)
    map.addLayer({
      id: 'buildings-fill',
      type: 'fill',
      source: 'buildings',
      'source-layer': 'building_footprints',
      paint: {
        'fill-color': [
          'match', ['get', 'usage'],
          '411', '#4CAF50', '412', '#8BC34A', '413', '#CDDC39',
          '414', '#AFB42B', '415', '#9E9D24',
          '401', '#2196F3', '402', '#03A9F4', '403', '#00BCD4', '404', '#0097A7',
          '421', '#9C27B0', '422', '#E91E63',
          '431', '#FF5722', '441', '#795548',
          '454', '#607D8B', '461', '#9E9E9E',
          '#FF9800'
        ],
        'fill-opacity': 0.6,
      },
    });
    map.addLayer({
      id: 'buildings-outline',
      type: 'line',
      source: 'buildings',
      'source-layer': 'building_footprints',
      paint: { 'line-color': 'rgba(0,0,0,0.2)', 'line-width': 0.5 },
    });

    // Polygon draw preview layers (after buildings-outline, before buildings-selected)
    map.addLayer({ id: 'draw-polygon-fill', type: 'fill', source: 'draw-polygon',
      paint: { 'fill-color': '#1a3a5c', 'fill-opacity': 0.15 } });
    map.addLayer({ id: 'draw-polygon-line', type: 'line', source: 'draw-polygon',
      paint: { 'line-color': '#1a3a5c', 'line-width': 2, 'line-dasharray': [4, 2] } });
    map.addLayer({ id: 'draw-vertices-circle', type: 'circle', source: 'draw-vertices',
      paint: { 'circle-radius': 5, 'circle-color': '#1a3a5c', 'circle-stroke-width': 2, 'circle-stroke-color': 'white' } });

    // Selected building highlight (white outline)
    map.addLayer({
      id: 'buildings-selected',
      type: 'line',
      source: 'buildings',
      'source-layer': 'building_footprints',
      filter: ['==', 'gmlid', ''],
      paint: { 'line-color': '#ffffff', 'line-width': 3 },
    });

    // LOD1 â€” 3D extrusion of building footprint
    map.addLayer({
      id: 'selected-lod1-extrusion',
      type: 'fill-extrusion',
      source: 'selected-lod1',
      paint: {
        'fill-extrusion-color': '#FFD600',
        'fill-extrusion-height': ['get', 'height'],
        'fill-extrusion-base': 0,
        'fill-extrusion-opacity': 0.85,
      },
    });

    // LOD2 surface layers â€” 3D extrusions
    map.addLayer({
      id: 'selected-lod2-ground-extrusion',
      type: 'fill-extrusion',
      source: 'selected-lod2-ground',
      paint: {
        'fill-extrusion-color': '#4CAF50',
        'fill-extrusion-height': 0,
        'fill-extrusion-base': 0,
        'fill-extrusion-opacity': 0.7,
      },
    });
    map.addLayer({
      id: 'selected-lod2-roof-extrusion',
      type: 'fill-extrusion',
      source: 'selected-lod2-roof',
      paint: {
        'fill-extrusion-color': '#2196F3',
        'fill-extrusion-height': 0,
        'fill-extrusion-base': 0,
        'fill-extrusion-opacity': 0.9,
      },
    });
    map.addLayer({
      id: 'selected-lod2-wall-line',
      type: 'line',
      source: 'selected-lod2-wall',
      paint: { 'line-color': '#FF6D00', 'line-width': 1.5 },
    });

    // â”€â”€ Box-select: canvas event listeners â”€â”€
    const canvas = map.getCanvas();

    canvas.addEventListener('mousedown', e => {
      if (selection.mode !== 'box' || e.button !== 0) return;
      e.preventDefault();
      boxState.active = true;
      boxState.startPixel = { x: e.offsetX, y: e.offsetY };
      const rb = document.getElementById('rubber-band');
      Object.assign(rb.style, {
        left: e.offsetX + 'px', top: e.offsetY + 'px',
        width: '0', height: '0', display: 'block',
      });
      boxState.div = rb;
    });

    canvas.addEventListener('mousemove', e => {
      if (!boxState.active) return;
      const { x: sx, y: sy } = boxState.startPixel;
      Object.assign(boxState.div.style, {
        left:   Math.min(sx, e.offsetX) + 'px',
        top:    Math.min(sy, e.offsetY) + 'px',
        width:  Math.abs(e.offsetX - sx) + 'px',
        height: Math.abs(e.offsetY - sy) + 'px',
      });
    });

    canvas.addEventListener('mouseup', e => {
      if (!boxState.active || selection.mode !== 'box') return;
      boxState.active = false;
      boxState.div.style.display = 'none';
      const { x: sx, y: sy } = boxState.startPixel;
      const ex = e.offsetX, ey = e.offsetY;
      if (Math.abs(ex - sx) < 5 || Math.abs(ey - sy) < 5) return;  // degenerate
      const features = map.queryRenderedFeatures(
        [[Math.min(sx, ex), Math.min(sy, ey)], [Math.max(sx, ex), Math.max(sy, ey)]],
        { layers: ['buildings-fill'] }
      );
      applySelection([...new Set(features.map(f => f.properties.gmlid))]);
    });

    // â”€â”€ Polygon-draw event listeners â”€â”€
    map.on('click', e => {
      if (selection.mode !== 'polygon') return;
      if (e.originalEvent.detail === 2) return;  // double-click fires click twice â€” ignore
      drawState.vertices.push([e.lngLat.lng, e.lngLat.lat]);
      updateDrawLayers();
    });

    map.on('dblclick', e => {
      if (selection.mode !== 'polygon') return;
      e.preventDefault();
      if (drawState.vertices.length < 3) { cancelPolygonDraw(); return; }
      finishPolygonDraw();
    });

    window.addEventListener('keydown', e => {
      if (e.key === 'Escape' && selection.mode === 'polygon') cancelPolygonDraw();
    });

    // â”€â”€ Building click / hover â”€â”€
    map.on('click', 'buildings-fill', e => {
      if (selection.mode !== 'normal') return;
      applySelection([e.features[0].properties.gmlid]);
    });

    map.on('mouseenter', 'buildings-fill', () => {
      if (selection.mode === 'normal') map.getCanvas().style.cursor = 'pointer';
    });
    map.on('mouseleave', 'buildings-fill', () => {
      if (selection.mode === 'normal') map.getCanvas().style.cursor = '';
    });

    // deck.gl overlay â€” rendered on top of MapLibre, used for LOD2 true-3D surfaces
    deckOverlay = new deck.MapboxOverlay({ interleaved: false, layers: [] });
    map.addControl(deckOverlay);
  });
}

// â”€â”€ Set selection mode â”€â”€
function setSelectionMode(mode) {
  if (selection.mode === 'polygon') cancelPolygonDraw();
  if (selection.mode === 'box') cancelBoxSelect();

  selection.mode = mode;

  // Update toolbar button active states
  ['sel-normal-btn', 'sel-box-btn', 'sel-poly-btn'].forEach(id => {
    document.getElementById(id)?.classList.remove('active');
  });
  const btnId = { normal: 'sel-normal-btn', box: 'sel-box-btn', polygon: 'sel-poly-btn' }[mode];
  document.getElementById(btnId)?.classList.add('active');

  if (mode === 'box') {
    map.dragPan.disable();
    map.getCanvas().style.cursor = 'crosshair';
  } else {
    map.dragPan.enable();
    map.getCanvas().style.cursor = mode === 'polygon' ? 'crosshair' : '';
  }
}

// â”€â”€ Apply a selection (array of gmlids) â”€â”€
async function applySelection(gmlids) {
  selection.gmlids = new Set(gmlids);
  selection.data.clear();
  selection.lod1Active = false;
  selection.lod2Active = false;

  map.easeTo({ pitch: 0, bearing: 0, duration: 300 });

  const filter = gmlids.length === 0
    ? ['==', 'gmlid', '']
    : ['in', ['get', 'gmlid'], ['literal', gmlids]];
  map.setFilter('buildings-selected', filter);

  clearLodLayers();

  if (gmlids.length === 0) {
    document.getElementById('detail-header').textContent = 'å»ºç‰©è©³ç´° / Building Detail';
    document.getElementById('detail-body').innerHTML =
      '<div class="detail-empty">åœ°å›³ä¸Šã®å»ºç‰©ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨<br>è©³ç´°æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>';
    return;
  }

  document.getElementById('detail-body').innerHTML = '<div class="spinner">Loadingâ€¦</div>';

  const total = gmlids.length;
  const tooMany = total > 50;
  const toFetch = gmlids.slice(0, 50);

  const results = await Promise.allSettled(toFetch.map(id => fetchBuilding(id)));
  results.forEach((r, i) => {
    if (r.status === 'fulfilled') selection.data.set(toFetch[i], r.value);
  });

  if (selection.data.size === 1) {
    const [singleData] = selection.data.values();
    renderDetailPanel(singleData);
  } else {
    renderMultiSelectPanel(tooMany, total);
  }
}

// â”€â”€ Fetch a single building (with persistent cache) â”€â”€
async function fetchBuilding(gmlid) {
  if (buildingCache.has(gmlid)) return buildingCache.get(gmlid);
  const res = await fetch(`${API}/buildings/${gmlid}`);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const data = await res.json();
  if (buildingCache.size >= 200) {
    buildingCache.delete(buildingCache.keys().next().value);
  }
  buildingCache.set(gmlid, data);
  return data;
}

// â”€â”€ Merge feature collections from multiple API responses â”€â”€
function mergeFeatureCollections(responses, accessor) {
  return { type: 'FeatureCollection', features: responses.flatMap(r => accessor(r).features) };
}

// â”€â”€ Render multi-building selection panel â”€â”€
function renderMultiSelectPanel(tooMany, total) {
  const values = [...selection.data.values()];
  const lod2Count = values.filter(d => d.attributes.has_lod2).length;
  const heights = values.map(d => d.attributes.measured_height).filter(h => h != null && h > 0);
  const avgHeight = heights.length > 0
    ? (heights.reduce((a, b) => a + b, 0) / heights.length).toFixed(1)
    : null;

  const usageCounts = {};
  values.forEach(d => {
    const u = d.attributes.usage_label || 'ä¸æ˜';
    usageCounts[u] = (usageCounts[u] || 0) + 1;
  });
  const topUsages = Object.entries(usageCounts).sort((a, b) => b[1] - a[1]).slice(0, 3);

  const lod2Attr = lod2Count === 0 ? 'disabled title="é¸æŠä¸­ã«LOD2ãƒ‡ãƒ¼ã‚¿ãªã—"' : '';

  let html = `
    <div class="section-title">é›†è¨ˆæƒ…å ±</div>
    <div class="attr-row"><span class="attr-label">é¸æŠæ£Ÿæ•°</span><span class="attr-value">${values.length}æ£Ÿ</span></div>
    <div class="attr-row"><span class="attr-label">LOD2ã‚ã‚Š</span><span class="attr-value">${lod2Count}æ£Ÿ</span></div>
    ${avgHeight != null ? `<div class="attr-row"><span class="attr-label">å¹³å‡é«˜ã•</span><span class="attr-value">${avgHeight} m</span></div>` : ''}
  `;

  if (topUsages.length > 0) {
    html += '<div class="section-title">ä¸»ãªç”¨é€”</div>';
    topUsages.forEach(([label, count]) => {
      html += `<div class="attr-row"><span class="attr-label">${escHtml(label)}</span><span class="attr-value">${count}æ£Ÿ</span></div>`;
    });
  }

  html += `
    <div class="section-title">ã‚¸ã‚ªãƒ¡ãƒˆãƒªè¡¨ç¤º</div>
    <div class="lod-section">
      <div class="lod-buttons">
        <button class="lod-btn" id="lod1-btn" onclick="toggleLod1()">LOD1</button>
        <button class="lod-btn" id="lod2-btn" onclick="toggleLod2()" ${lod2Attr}>LOD2</button>
      </div>
      <div class="lod-legend" id="lod-legend" style="display:none">
        <div class="legend-item"><div class="legend-dot" style="background:#4CAF50"></div>åœ°é¢ Ground</div>
        <div class="legend-item"><div class="legend-dot" style="background:#2196F3"></div>å±‹æ ¹ Roof</div>
        <div class="legend-item"><div class="legend-dot" style="background:#FF9800"></div>å£ Wall</div>
      </div>
    </div>
  `;

  if (tooMany) {
    html += `<div style="margin-top:12px;padding:8px 10px;background:#fef3c7;border-radius:6px;font-size:0.75rem;color:#92400e">
      âš  ${total}æ£Ÿé¸æŠä¸­ã€‚æœ€åˆã®50æ£Ÿã®ã¿è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚
    </div>`;
  }

  document.getElementById('detail-header').textContent = `${values.length}æ£Ÿ é¸æŠä¸­`;
  document.getElementById('detail-body').innerHTML = html;
}

// â”€â”€ Render single-building attribute panel â”€â”€
function renderDetailPanel(data) {
  document.getElementById('detail-header').textContent = 'å»ºç‰©è©³ç´° / Building Detail';
  const a = data.attributes;
  const hasLod2 = a.has_lod2;

  function attrRow(label, value) {
    return `<div class="attr-row">
      <span class="attr-label">${label}</span>
      <span class="attr-value">${escHtml(String(value))}</span>
    </div>`;
  }

  // â”€â”€ Section 1: åŸºæœ¬æƒ…å ± â”€â”€
  let basicHtml = '<div class="section-title">åŸºæœ¬æƒ…å ±</div>';
  if (a.name) basicHtml += attrRow('å»ºç‰©åç§°', a.name);
  basicHtml += attrRow('ç”¨é€”', `${a.usage_label} (${a.usage || 'â€”'})`);
  if (a.class_label) basicHtml += attrRow('å»ºç‰©åŒºåˆ†', `${a.class_label} (${a.class})`);
  basicHtml += attrRow('é«˜ã•', a.measured_height != null ? `${a.measured_height} m` : 'ä¸æ˜');
  basicHtml += attrRow('åœ°ä¸Šéšæ•°', a.storeys_above_ground != null ? `${a.storeys_above_ground} éš` : 'ä¸æ˜');
  if (a.storeys_below_ground) basicHtml += attrRow('åœ°ä¸‹éšæ•°', `${a.storeys_below_ground} éš`);

  // â”€â”€ Section 2: å±æ€§æƒ…å ± (generic attrs) â”€â”€
  let genericHtml = '';
  if (data.generic_attrs && data.generic_attrs.length > 0) {
    genericHtml = '<div class="section-title">å±æ€§æƒ…å ±</div>';
    genericHtml += data.generic_attrs.map(g =>
      attrRow(g.name, g.value != null ? g.value : 'â€”')
    ).join('');
  }

  // â”€â”€ Section 3: ã‚¸ã‚ªãƒ¡ãƒˆãƒªè¡¨ç¤º â”€â”€
  const lod2Disabled = !hasLod2 ? 'disabled title="ã“ã®ãƒ“ãƒ«ã¯LOD2ãƒ‡ãƒ¼ã‚¿ãªã—"' : '';
  const lodHtml = `
    <div class="section-title">ã‚¸ã‚ªãƒ¡ãƒˆãƒªè¡¨ç¤º</div>
    <div class="lod-section">
      <div class="lod-buttons">
        <button class="lod-btn" id="lod1-btn" onclick="toggleLod1()">LOD1</button>
        <button class="lod-btn" id="lod2-btn" onclick="toggleLod2()" ${lod2Disabled}>LOD2</button>
      </div>
      <div class="lod-legend" id="lod-legend" style="display:none">
        <div class="legend-item"><div class="legend-dot" style="background:#4CAF50"></div>åœ°é¢ Ground</div>
        <div class="legend-item"><div class="legend-dot" style="background:#2196F3"></div>å±‹æ ¹ Roof</div>
        <div class="legend-item"><div class="legend-dot" style="background:#FF9800"></div>å£ Wall</div>
      </div>
      <div style="margin-top:8px; font-size:0.72rem; color:#94a3b8; line-height:1.5">
        ${hasLod2 ? 'LOD2: å£ãƒ»å±‹æ ¹ãƒ»åœ°é¢ã®é¢ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š' : 'LOD2ãƒ‡ãƒ¼ã‚¿ãªã—ï¼ˆLOD1ã®ã¿ï¼‰'}
      </div>
    </div>`;

  // â”€â”€ Section 4: ID â”€â”€
  const idHtml = '<div class="section-title">ID</div>' + attrRow('GML ID', data.gmlid);

  document.getElementById('detail-body').innerHTML =
    basicHtml + genericHtml + lodHtml + idHtml;
}

// â”€â”€ LOD toggles â”€â”€
function toggleLod1() {
  if (selection.data.size === 0) return;
  selection.lod1Active = !selection.lod1Active;

  const btn = document.getElementById('lod1-btn');
  btn.classList.toggle('active', selection.lod1Active);

  if (selection.lod1Active) {
    const merged = mergeFeatureCollections([...selection.data.values()], r => r.lod1);
    map.getSource('selected-lod1').setData(merged);
    map.easeTo({ pitch: 45, bearing: -15, duration: 500 });
  } else {
    map.getSource('selected-lod1').setData({ type: 'FeatureCollection', features: [] });
    if (!selection.lod2Active) map.easeTo({ pitch: 0, bearing: 0, duration: 500 });
  }
}

function toggleLod2() {
  const lod2Builds = [...selection.data.values()].filter(d => d.attributes.has_lod2);
  if (lod2Builds.length === 0) return;
  selection.lod2Active = !selection.lod2Active;

  const btn = document.getElementById('lod2-btn');
  btn.classList.toggle('active', selection.lod2Active);
  const legend = document.getElementById('lod-legend');
  if (legend) legend.style.display = selection.lod2Active ? 'block' : 'none';

  if (selection.lod2Active) {
    deckOverlay.setProps({
      layers: [
        new deck.PolygonLayer({
          id: 'lod2-ground',
          data: mergeFeatureCollections(lod2Builds, r => r.lod2.ground).features,
          getPolygon: f => f.geometry.coordinates[0],
          getFillColor: [76, 175, 80, 180],
          getLineColor: [76, 175, 80, 255],
          extruded: false,
          stroked: true,
          lineWidthMinPixels: 1,
          pickable: false,
        }),
        new deck.PolygonLayer({
          id: 'lod2-roof',
          data: mergeFeatureCollections(lod2Builds, r => r.lod2.roof).features,
          getPolygon: f => f.geometry.coordinates[0],
          getFillColor: [33, 150, 243, 200],
          getLineColor: [33, 150, 243, 255],
          extruded: false,
          stroked: true,
          lineWidthMinPixels: 1,
          pickable: false,
        }),
        new deck.PolygonLayer({
          id: 'lod2-wall',
          data: mergeFeatureCollections(lod2Builds, r => r.lod2.wall).features,
          getPolygon: f => f.geometry.coordinates[0],
          getFillColor: [255, 152, 0, 160],
          getLineColor: [255, 109, 0, 220],
          extruded: false,
          stroked: true,
          lineWidthMinPixels: 0.5,
          pickable: false,
        }),
      ],
    });
    map.easeTo({ pitch: 45, bearing: -15, duration: 500 });
  } else {
    clearLodLayers(/* keepLod1 */ true);
    if (!selection.lod1Active) map.easeTo({ pitch: 0, bearing: 0, duration: 500 });
  }
}

function clearLodLayers(keepLod1 = false) {
  const empty = { type: 'FeatureCollection', features: [] };
  if (!keepLod1) {
    map.getSource('selected-lod1')?.setData(empty);
  }
  // MapLibre LOD2 sources (kept for compatibility; data no longer set by toggleLod2)
  map.getSource('selected-lod2-wall')?.setData(empty);
  map.getSource('selected-lod2-roof')?.setData(empty);
  map.getSource('selected-lod2-ground')?.setData(empty);
  // Clear deck.gl LOD2 layers
  if (deckOverlay) deckOverlay.setProps({ layers: [] });
}

// â”€â”€ Clear all selections â”€â”€
function clearSelection() {
  selection.gmlids.clear();
  selection.data.clear();
  selection.lod1Active = false;
  selection.lod2Active = false;
  if (map) {
    map.setFilter('buildings-selected', ['==', 'gmlid', '']);
    clearLodLayers();
  }
  document.getElementById('detail-header').textContent = 'å»ºç‰©è©³ç´° / Building Detail';
  document.getElementById('detail-body').innerHTML =
    '<div class="detail-empty">åœ°å›³ä¸Šã®å»ºç‰©ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨<br>è©³ç´°æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>';
}

// â”€â”€ Cancel box select (cleanup rubber-band) â”€â”€
function cancelBoxSelect() {
  boxState.active = false;
  const rb = document.getElementById('rubber-band');
  if (rb) rb.style.display = 'none';
}

// â”€â”€ Polygon draw helpers â”€â”€
function updateDrawLayers() {
  const verts = drawState.vertices;
  map.getSource('draw-vertices').setData({
    type: 'FeatureCollection',
    features: verts.map(v => ({
      type: 'Feature',
      geometry: { type: 'Point', coordinates: v },
      properties: {},
    })),
  });
  if (verts.length >= 2) {
    map.getSource('draw-polygon').setData({
      type: 'FeatureCollection',
      features: [{
        type: 'Feature',
        geometry: { type: 'Polygon', coordinates: [[...verts, verts[0]]] },
        properties: {},
      }],
    });
  } else {
    map.getSource('draw-polygon').setData({ type: 'FeatureCollection', features: [] });
  }
}

function finishPolygonDraw() {
  const verts = drawState.vertices;
  const poly = turf.polygon([[...verts, verts[0]]]);

  const renderedFeatures = map.queryRenderedFeatures({ layers: ['buildings-fill'] });
  const matchedGmlids = [];
  const seen = new Set();

  renderedFeatures.forEach(f => {
    const gmlid = f.properties.gmlid;
    if (seen.has(gmlid)) return;
    seen.add(gmlid);

    const ring = f.geometry.type === 'MultiPolygon'
      ? f.geometry.coordinates[0][0]
      : f.geometry.coordinates[0];
    const cx = ring.reduce((s, p) => s + p[0], 0) / ring.length;
    const cy = ring.reduce((s, p) => s + p[1], 0) / ring.length;

    if (turf.booleanPointInPolygon(turf.point([cx, cy]), poly)) {
      matchedGmlids.push(gmlid);
    }
  });

  cancelPolygonDraw();
  if (matchedGmlids.length > 0) applySelection(matchedGmlids);
}

function cancelPolygonDraw() {
  drawState.vertices = [];
  if (map) {
    map.getSource('draw-polygon')?.setData({ type: 'FeatureCollection', features: [] });
    map.getSource('draw-vertices')?.setData({ type: 'FeatureCollection', features: [] });
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
checkHealth();
</script>
</body>
</html>
